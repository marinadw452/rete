#!/bin/bash

# ==========================================
# ุณูุฑูุจุช ุฅุนุฏุงุฏ ูุชุดุบูู ูุธุงู ุทูุทู
# ==========================================

set -e  # ุงูุชููู ุนูุฏ ุฃู ุฎุทุฃ

# ุฃููุงู ูููุฎุฑุฌุงุช
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ุฏุงูุฉ ุทุจุงุนุฉ ููููุฉ
print_step() {
    echo -e "${BLUE}==>${NC} ${1}"
}

print_success() {
    echo -e "${GREEN}โ${NC} ${1}"
}

print_error() {
    echo -e "${RED}โ${NC} ${1}"
}

print_warning() {
    echo -e "${YELLOW}โ๏ธ${NC} ${1}"
}

print_info() {
    echo -e "${CYAN}โน๏ธ${NC} ${1}"
}

# ุจุฏุงูุฉ ุงูุณูุฑูุจุช
clear
echo -e "${PURPLE}
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ๐ ูุธุงู ุทูุทู                โ
โ        ุฅุนุฏุงุฏ ูุชุดุบูู ุงููุธุงู           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}
"

# ุงูุชุญูู ูู ุงููุชุทูุจุงุช
print_step "ุงูุชุญูู ูู ุงููุชุทูุจุงุช..."

# ุงูุชุญูู ูู Docker
if ! command -v docker &> /dev/null; then
    print_error "Docker ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Docker ุฃููุงู"
    exit 1
fi

# ุงูุชุญูู ูู Docker Compose
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    print_error "Docker Compose ุบูุฑ ูุซุจุช. ูุฑุฌู ุชุซุจูุช Docker Compose ุฃููุงู"
    exit 1
fi

print_success "ุฌููุน ุงููุชุทูุจุงุช ูุชููุฑุฉ"

# ุงูุชุญูู ูู ุงููููุงุช ุงููุทููุจุฉ
print_step "ุงูุชุญูู ูู ุงููููุงุช ุงููุทููุจุฉ..."

required_files=(
    "main.py"
    "config.py" 
    "docker-compose.yml"
    "Dockerfile"
    "requirements.txt"
    "init.sql"
    "neighborhoods.json"
)

missing_files=()
for file in "${required_files[@]}"; do
    if [[ ! -f "$file" ]]; then
        missing_files+=("$file")
    fi
done

if [[ ${#missing_files[@]} -gt 0 ]]; then
    print_error "ุงููููุงุช ุงูุชุงููุฉ ููููุฏุฉ:"
    printf '  - %s\n' "${missing_files[@]}"
    exit 1
fi

print_success "ุฌููุน ุงููููุงุช ุงููุทููุจุฉ ููุฌูุฏุฉ"

# ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุจูุช
print_step "ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุจูุช..."

if grep -q "YOUR_BOT_TOKEN_HERE" config.py; then
    print_warning "ุชุญุชุงุฌ ูุชุนุฏูู BOT_TOKEN ูู ููู config.py"
    echo -e "${CYAN}ุงุญุตู ุนูู ุงูุชููู ูู: https://t.me/BotFather${NC}"
    read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# ุงูุชุญูู ูู ููู ุงูุฃุญูุงุก
print_step "ุงูุชุญูู ูู ููู ุงูุฃุญูุงุก..."
if [[ ! -s "neighborhoods.json" ]]; then
    print_warning "ููู neighborhoods.json ูุงุฑุบ ุฃู ุบูุฑ ููุฌูุฏ"
    echo "ุณูุชู ุฅูุดุงุก ููู ุชุฌุฑูุจู..."
    
    cat > neighborhoods.json << 'EOF'
{
  "ุงูุฑูุงุถ": [
    "ุงูููุฒ", "ุงูุนููุง", "ุงูุฎุฑุฌ", "ุงูุดูุง", "ุงููุณูู", "ุงูุฑูุถุฉ",
    "ุงูุณูููุงููุฉ", "ุงููุงุณููู", "ุงููุฑุฌุณ", "ุงููุงุฏู", "ุงูุฑุจูุฉ"
  ],
  "ุฌุฏุฉ": [
    "ุงูุจูุฏ", "ุงูุญูุฑุงุก", "ุงูุฑูุถุฉ", "ุงูุฒูุฑุงุก", "ุงูููุฑููุด", "ุงููุฒูุฉ",
    "ุงูุตูุง", "ุงูุดุงุทุฆ", "ุงูุณูุงูุฉ", "ุงูุจูุงุฏู", "ุงูุซุนุงูุจุฉ"
  ]
}
EOF
    print_success "ุชู ุฅูุดุงุก ููู neighborhoods.json"
fi

# ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ
print_step "ุฅูุดุงุก ุงููุฌูุฏุงุช..."
mkdir -p logs backups

# ุจูุงุก ูุชุดุบูู ุงููุธุงู
print_step "ุจูุงุก ุตูุฑ Docker..."
docker-compose build

print_step "ุชุดุบูู ุงููุธุงู..."
docker-compose up -d

# ุงูุชุธุงุฑ ุจุฏุก ุงูุฎุฏูุงุช
print_step "ุงูุชุธุงุฑ ุจุฏุก ุงูุฎุฏูุงุช..."
sleep 10

# ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุฏูุงุช
print_step "ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุฏูุงุช..."

if docker-compose ps | grep -q "Up"; then
    print_success "ุชู ุชุดุบูู ุงููุธุงู ุจูุฌุงุญ!"
    echo
    print_info "ูุนูููุงุช ูููุฏุฉ:"
    echo -e "  ๐ ููุญุฉ ุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${CYAN}http://localhost:8080${NC}"
    echo -e "  ๐ ูุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช: ${YELLOW}make status${NC}"
    echo -e "  ๐ ูุนุฑุถ ุงูุณุฌูุงุช: ${YELLOW}make logs${NC}"
    echo
    print_info "ุจูุงูุงุช ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช:"
    echo -e "  ๐ก ุงูุฎุงุฏู: ${CYAN}postgres${NC}"
    echo -e "  ๐ค ุงููุณุชุฎุฏู: ${CYAN}postgres${NC}"
    echo -e "  ๐ ูููุฉ ุงููุฑูุฑ: ${CYAN}taktak123${NC}"
    echo -e "  ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${CYAN}taktak_db${NC}"
    echo
else
    print_error "ูุดู ูู ุชุดุบูู ุงููุธุงู"
    echo "ุชุญูู ูู ุงูุณุฌูุงุช:"
    echo "  docker-compose logs"
    exit 1
fi

# ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
print_step "ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช..."
if docker-compose exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then
    print_success "ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุตูุฉ ููุชุงุญุฉ"
else
    print_warning "ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุงุญุฉ ุญุงููุงู"
fi

# ุฅุญุตุงุฆูุงุช ุงููุธุงู
print_step "ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุธุงู..."
echo
echo -e "${PURPLE}๐ ุญุงูุฉ ุงููุธุงู:${NC}"
docker-compose ps

echo -e "
${GREEN}๐ ุชู ุฅุนุฏุงุฏ ูุธุงู ุทูุทู ุจูุฌุงุญ!${NC}

${YELLOW}ุงูุฎุทูุงุช ุงูุชุงููุฉ:${NC}
1. ุชุฃูุฏ ูู ุชุนุฏูู BOT_TOKEN ูู config.py
2. ุงุฎุชุจุฑ ุงูุจูุช ุนูู ุชููุฌุฑุงู
3. ุฑุงูุจ ุงูุณุฌูุงุช: make logs

${CYAN}ุฃูุงูุฑ ูููุฏุฉ:${NC}
  make status     - ุญุงูุฉ ุงูุฎุฏูุงุช
  make logs       - ุนุฑุถ ุงูุณุฌูุงุช
  make restart    - ุฅุนุงุฏุฉ ุชุดุบูู
  make clean      - ุชูุธูู
  make backup     - ูุณุฎุฉ ุงุญุชูุงุทูุฉ

${PURPLE}ูุชููู ูู ุชุฌุฑุจุฉ ุฑุงุฆุนุฉ ูุน ูุธุงู ุทูุทู! ๐${NC}
"
